# Card 2.1 Component Development Guide

## Overview

This document summarizes Card 2.1 Development process and key points of component systemsï¼ŒBased on dashboard componentsï¼ˆgauge-chartï¼‰The complete development process ofã€‚

## Component development process

### 1. File structure creation

Card 2.1 Components must follow the following file structureï¼š

```
src/card2.1/components/
â””â”€â”€ [category]/        # category folderï¼ˆlike chart, system, alarmï¼‰
    â””â”€â”€ [subcategory]/ # subcategoryï¼ˆlike data, statusï¼‰
        â””â”€â”€ [component-name]/
            â”œâ”€â”€ definition.ts      # Component definitions and metadata
            â”œâ”€â”€ index.vue          # Component implementation
            â”œâ”€â”€ setting.vue        # Configuration panelUI
            â”œâ”€â”€ settingConfig.ts   # Configuration item type definition
            â””â”€â”€ index.ts           # Export file
```

#### Exampleï¼šDashboard components
```
src/card2.1/components/chart/data/gauge-chart/
â”œâ”€â”€ definition.ts
â”œâ”€â”€ index.vue
â”œâ”€â”€ setting.vue
â”œâ”€â”€ settingConfig.ts
â””â”€â”€ index.ts
```

### 2. Component definitionï¼ˆdefinition.tsï¼‰

#### Required fields
```typescript
export const gaugeChartDefinition: ComponentDefinition = {
  // Basic information
  id: 'gauge-chart',
  name: 'Dashboard',
  description: 'Circular dashboard chartï¼ŒUsed to display a single value and its position within a range',
  category: 'chart',
  subCategory: 'data',
  version: '1.0.0',

  // Component configuration
  component: GaugeChartCustomize,

  // ðŸ”¥ keyï¼šData source definition
  dataSources: [
    {
      key: 'main',
      name: 'data source',
      description: 'Primary data source for dashboards',
      supportedTypes: ['static', 'api', 'websocket'],
      required: false,
      // ðŸ”¥ importantï¼šProvide example values
      example: {
        value: 75,
        unit: 'â„ƒ',
        metricsName: 'temperature',
        timestamp: '2025-10-15T10:30:00.000Z'
      }
    }
  ],

  // Interactive capabilitiesï¼ˆOptionalï¼‰
  interactionCapabilities: {
    canTrigger: false,
    canReceive: false,
    exposedProperties: []
  }
}
```

#### Data source design principles

**single source of data vs Multiple data sources**

- âœ… **single source of data**ï¼šWorks with most components
  ```typescript
  dataSources: [{
    key: 'main',
    example: { value, unit, metricsName, timestamp }
  }]
  ```

- âœ… **Multiple data sources**ï¼šOnly for multi-series chartsï¼ˆmultiple curvesã€Multiple bar charts, etc.ï¼‰
  ```typescript
  dataSources: [
    { key: 'series1', example: {...} },
    { key: 'series2', example: {...} }
  ]
  ```

**data source vs Configuration items**

- **data sourceï¼ˆdataSourcesï¼‰**ï¼šdynamic dataï¼Œfrom APIã€WebSocket wait
- **Configuration itemsï¼ˆcomponentï¼‰**ï¼šstatic settingsï¼Œsuch as colorã€sizeã€minimum valueã€maximum value

### 3. Configuration type definitionï¼ˆsettingConfig.tsï¼‰

```typescript
export interface GaugeChartCustomize {
  // Data configurationï¼ˆstatic configurationï¼Œnon data sourceï¼‰
  value?: number        // default value
  min?: number          // minimum value
  max?: number          // maximum value
  title?: string        // title
  unit?: string         // unit

  // Style configuration
  radius?: string       // Dashboard radius
  thickness?: number    // Indicator thickness
  titleColor?: string   // title color
  valueColor?: string   // numerical color

  // Animation configuration
  animationDuration?: number
}
```

### 4. Component implementationï¼ˆindex.vueï¼‰

#### Key takeaways

**4.1 use useCard2Props Hook**

```typescript
// ðŸ”¥ critical fixï¼šdata Must be passed in computed Package
const { unifiedConfig, displayData } = useCard2Props({
  config: props.config,
  data: computed(() => props.data),  // âœ… correctï¼šCreate reactive dependencies
  // data: props.data,                // âŒ mistakeï¼šUnable to respond to changes
  componentId: props.componentId
})
```

**Why must use `computed(() => props.data)`ï¼Ÿ**

- `props.data` is responsive dataï¼ŒBut passing it directly will only pass a snapshot of the current value
- `computed(() => props.data)` Create a computed propertyï¼ŒBuild responsive dependency chains
- when `props.data` renewæ—¶ï¼ŒComputed properties are re-executedï¼Œtrigger `useCard2Props` internal `displayData` renew

**4.2 Data access path**

Data structure returned by the data sourceï¼š
```typescript
{
  main: {           // data source key
    data: {         // actual data
      value: 75,
      unit: 'â„ƒ',
      metricsName: 'temperature',
      timestamp: '...'
    }
  }
}
```

Access methodï¼š
```typescript
const displayValue = computed(() => {
  // Data source firstï¼ŒConfiguration values
  const dataSourceValue = displayData.value?.main?.data?.value
  return Number(dataSourceValue ?? unifiedConfig.value.component?.value ?? 75)
})
```

**4.3 Complete example**

```vue
<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { useCard2Props } from '@/card2.1/hooks'
import type { GaugeChartCustomize } from './settingConfig'

interface Props {
  config: GaugeChartCustomize
  data?: Record<string, unknown>
  componentId?: string
}

const props = withDefaults(defineProps<Props>(), {
  data: () => ({})
})

// ðŸ”¥ keyï¼šuse computed Package props.data
const { unifiedConfig, displayData } = useCard2Props({
  config: props.config,
  data: computed(() => props.data),
  componentId: props.componentId
})

// Calculate display valueï¼ˆData source firstï¼‰
const displayValue = computed(() => {
  const dataSourceValue = displayData.value?.main?.data?.value
  return Number(dataSourceValue ?? unifiedConfig.value.component?.value ?? 75)
})

// Component logic...
</script>
```

### 5. Configuration panelï¼ˆsetting.vueï¼‰

use Naive UI Component build configuration interfaceï¼š

```vue
<template>
  <n-space vertical :size="16">
    <n-form-item label="current value">
      <n-input-number
        v-model:value="localConfig.value"
        :min="0"
        :max="100"
        @update:value="handleConfigChange"
      />
    </n-form-item>

    <!-- More configuration items... -->
  </n-space>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue'
import { NSpace, NFormItem, NInputNumber } from 'naive-ui'
import type { GaugeChartCustomize } from './settingConfig'

// Props and emits
const props = defineProps<{ config: GaugeChartCustomize }>()
const emit = defineEmits<{
  (e: 'update:config', config: GaugeChartCustomize): void
}>()

// local configuration
const localConfig = ref<GaugeChartCustomize>({ ...props.config })

// Configuration change handling
const handleConfigChange = () => {
  emit('update:config', { ...localConfig.value })
}

// Monitor external configuration changes
watch(() => props.config, (newConfig) => {
  localConfig.value = { ...newConfig }
}, { deep: true })
</script>
```

### 6. Component registration

#### 6.1 Category mapping

exist `src/card2.1/core2/registry/category-definition.ts` Add mappingï¼š

```typescript
export const COMPONENT_TO_CATEGORY_MAP: Record<string, string> = {
  // ... Other components
  'gauge-chart': 'data',  // Added dashboard component mapping
}
```

#### 6.2 Automatic registration

System passed `import.meta.glob` Automatically discover and register componentsï¼ŒNo need to register manuallyã€‚

### 7. Frequently Asked Questions and Solutions

#### question1ï¼šComponent shows default valueï¼ŒDo not display data source data

**reason**ï¼šReactive dependency chain broken

**solution**ï¼š
```typescript
// âŒ mistake
const { displayData } = useCard2Props({
  data: props.data
})

// âœ… correct
const { displayData } = useCard2Props({
  data: computed(() => props.data)
})
```

#### question2ï¼šThe sample value is not displayed in the data source configuration interface

**reason**ï¼šSample value access path error

**solution**ï¼š
```typescript
// âŒ mistake
const exampleData = currentDataSource?.originalData?.originalData?.example

// âœ… correct
const exampleData = currentDataSource?.originalData?.example
```

#### question3ï¼šComponents are classified into "other" Classification

**reason**ï¼šNot here COMPONENT_TO_CATEGORY_MAP Add mapping

**solution**ï¼š
exist `category-definition.ts` Add componentIDMapping to categories

#### question4ï¼šData source structure identification failed

**reason**ï¼š`useCard2Props` of `isDataFromWarehouse` Check that nested structures are not supported

**solution**ï¼š
The system already supports nested structure recognitionï¼ˆlike `{ main: { data: {...} } }`ï¼‰ï¼ŒNo additional processing required

## development checklist

When developing new componentsï¼ŒCheck each item according to the following listï¼š

### File structure
- [ ] Create the correct directory structure
- [ ] Contains all required filesï¼ˆdefinition.ts, index.vue, setting.vue, settingConfig.ts, index.tsï¼‰

### Component definition
- [ ] Define the correct category and subCategory
- [ ] Data source design is reasonableï¼ˆsingle vs Multiple data sourcesï¼‰
- [ ] Provide complete example valuesï¼ˆexampleï¼‰
- [ ] Distinguish between data sources and configuration items

### Component implementation
- [ ] use `computed(() => props.data)` Package data parameter
- [ ] Correct access to data pathï¼ˆdisplayData.value?.main?.data?.xxxï¼‰
- [ ] Data source firstï¼ŒConfiguration values
- [ ] Add detailed Chinese comments

### Configuration panel
- [ ] use Naive UI components
- [ ] Implement two-way bindingï¼ˆv-model and emitï¼‰
- [ ] Monitor external configuration changes

### Component registration
- [ ] exist COMPONENT_TO_CATEGORY_MAP Add mapping
- [ ] Verify that components appear under the correct category

### Test verification
- [ ] Static configuration can be displayed correctly
- [ ] Data source data can be displayed correctly
- [ ] Components are updated responsively when the data source is updated
- [ ] Configuration panel modifications can take effect in real time

## best practices

1. **priority use Naive UI components**ï¼šAvoid reinventing the wheel
2. **complete type definition**ï¼šavoid using `any`
3. **Detailed Chinese notes**ï¼šEspecially business logic and key fix points
4. **Reactive dependencies**ï¼štransfer props Must be used when `computed` or `toRef`
5. **Data source design**ï¼šFollow single responsibilityï¼ŒDistinguish between dynamic data and static configuration
6. **Example value complete**ï¼šEnsure that the data source configuration interface can be previewed correctly

## Debugging Tips

### View data flow
```typescript
// Add temporary logs to the component
console.log('displayData:', displayData.value)
console.log('unifiedConfig:', unifiedConfig.value)
```

### Verify responsive
```typescript
// examine computed whether triggered
const displayValue = computed(() => {
  console.log('displayValue computed triggered')
  return displayData.value?.main?.data?.value
})
```

### Check data source execution
Open browser developer toolsï¼ŒCheck Network panelå’Œ Console panelï¼Œconfirmï¼š
- API Request successful
- Data format is correct
- Component receives data update

## Reference components

It is recommended to refer to the implementation of the following componentsï¼š
- **Dashboard components**ï¼š`src/card2.1/components/chart/data/gauge-chart/`
- **digital indicator**ï¼š`src/card2.1/components/chart/data/digit-indicator/`

## Summarize

Card 2.1 Core points of component developmentï¼š

1. **Strict file structure**ï¼šEnsure that the automatic registration mechanism works properly
2. **Correct data source design**ï¼šSingle data source preferredï¼ŒDistinguish between data and configuration
3. **Reactive dependency handling**ï¼šuse `computed(() => props.data)` Build dependency chain
4. **Standardized configuration interface**ï¼šuse `useCard2Props` Unified management configuration
5. **complete type definition**ï¼šTypeScript strict modeï¼Œavoid `any`

follow this guideï¼Œcan quickly develop Card 2.1 Architecturally regulated high-quality componentsã€‚
